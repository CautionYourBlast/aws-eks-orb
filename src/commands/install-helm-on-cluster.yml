description: |
  Install helm into an existing eks cluster.
  Note: Currently this does not apply any security configurations
  and gives Tiller admin access to the entire cluster.
  For further reading see https://github.com/helm/helm/blob/master/docs/securing_installation.md

  Requirements: kubectl, updated kubeconfig

steps:
  - install-helm-client
  - run:
      name: Create new service account manifest for tiller to use
      command: |
        cat \<<-EOF > helm-rbac.yaml
        ---
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: tiller
          namespace: kube-system
        ---
        apiVersion: rbac.authorization.k8s.io/v1beta1
        kind: ClusterRoleBinding
        metadata:
          name: tiller
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: cluster-admin
        subjects:
          - kind: ServiceAccount
            name: tiller
            namespace: kube-system
        EOF

        # Apply the config to the cluster
        kubectl apply -f helm-rbac.yaml
  - run:
      name: Install tiller into the cluster
      command: |
        helm init --service-account tiller --wait
